rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    function signedIn() { return request.auth != null; }

    function myRole() {
        return signedIn()
        ? get(/databases/$(database)/documents/members/$(request.auth.uid)).data.role
        : null;
    }

  function isAdmin() { return myRole() in ['admin', 'super_admin']; }
  function isSchoolPersonnel() { return myRole() == 'school_personnel'; }

  match /members/{uid} {
    allow read: if signedIn() && (request.auth.uid == uid || isAdmin());

    // Admins can create/delete member records
    allow create, delete: if isAdmin() &&
      request.resource.data.keys().hasOnly(['role','joinedAt','email','displayName']) &&
      request.resource.data.role in ['super_admin','admin','school_personnel','student'];

    allow update: if isAdmin();
  }

  // Invitations collection
  match /invitations/{id} {
    allow create: if isAdmin() &&
      request.resource.data.keys().hasOnly(['email','role','invitedAt','invitedBy','status']) &&
      request.resource.data.role in ['super_admin','admin','school_personnel','student'];

    allow read, update, delete: if isAdmin();
  }

    match /surveys/{surveyID} {

        allow read: if isAdmin() || isSchoolPersonnel();

        allow create, update, delete: if isAdmin();
    }

    // We will add more rules for analytics and also things such user managment for the admins

  }
}