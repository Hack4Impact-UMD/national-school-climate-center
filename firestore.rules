rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }
    function myUid() { return request.auth.uid; }

    // role lookup from users doc
    function myRole() {
      return signedIn()
        ? get(/databases/$(database)/documents/users/$(myUid())).data.role
        : null;
    }
    function isAdmin() { return myRole() == 'admin'; }
    function isStaff() { return myRole() == 'school_personnel'; }

    match /users/{uid} {
      allow read: if signedIn() && (uid == myUid() || isAdmin());
      allow create, update, delete: if isAdmin();
    }

    match /questionBank/{qid} {
      allow read: if signedIn();                 // everyone logged in can read
      allow create, update, delete: if isAdmin();// only admins manage bank
    }

    match /surveys/{surveyId} {
      allow read: if signedIn();                 // or restrict by visibility
      allow create, update, delete: if isAdmin();
    }

    match /responses/{rid} {
      // Students create their own responses; must include consent
      allow create: if signedIn()
        && request.resource.data.uid == myUid()
        && request.resource.data.consent == true;

      // Immutable once created (prevent edits)
      allow update: if false;

      // Reads: staff/admin; a student can read their own response
      allow read: if (signedIn() && resource.data.uid == myUid())
                  || isAdmin() || isStaff();

      allow delete: if isAdmin();
    }

    
  }
}
