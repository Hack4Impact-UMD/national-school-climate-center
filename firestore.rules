rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    function signedIn() { return request.auth != null; }

    function myRole() {
        return signedIn()
        ? get(/databases/$(database)/documents/members/$(request.auth.uid)).data.role
        : null;
    }

    function isSuperAdmin() { return myRole() == 'super_admin';}
    function isAdmin()      {return myRole() == 'admin';}
    function isSchoolPersonnel      { return myRole() == 'school_personnel' }

    match /members/{uid} {
        allow read: if signedIn() && (request.auth.uid == uid || isAdmin() || isSuperAdmin());

        allow create, delete: if isSuperAdmin() &&
            request.resource.data.keys().hasOnly(['role','joinedAt']) &&
            request.resource.data.role in ['super_admin','admin','school_personnel'];

        allow update: if isSuperAdmin();
    }

    match /surveys/{surveyID} {

        allow read: if isSuperAdmin() || isAdmin() || isSchoolPersonnel();

        allow create, update, delete: if isSuperAdmin() || isAdmin();
    }

    // We will add more rules for analytics and also things such user managment for the admins

}