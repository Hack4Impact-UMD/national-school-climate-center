rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }

    function myRole() {
      return signedIn()
        ? get(/databases/$(database)/documents/members/$(request.auth.uid)).data.role
        : null;
    }

    function isAdmin() { return myRole() in ['admin', 'super_admin']; }
    function isSchoolPersonnel() { return myRole() == 'school_personnel'; }

    match /members/{uid} {
      // Only the signed-in user can read their own member doc, or an admin
      allow read: if signedIn() && (request.auth.uid == uid || isAdmin());

      // Admins can create/delete member docs with strict shape
      allow create, delete: if isAdmin() &&
        request.resource.data.keys().hasOnly(['role','joinedAt', 'email']) &&
        request.resource.data.role in ['admin','school_personnel'];

      // Admins update
      allow update: if isAdmin();
    }

    match /surveys/{surveyID} {
      allow read: if isAdmin() || isSchoolPersonnel();
      allow create, update, delete: if isAdmin();
    }
  }
}
